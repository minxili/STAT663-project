---
title: "pollutant"
format: html
freeze: auto
---

## Packages and data loading
```{r}
library(tidyverse)
library(lubridate)
library(janitor)

poll <- read_csv("pollution_2000_2023.csv") %>%
  clean_names()

glimpse(poll)
summary(poll)
```

```{r}
poll_clean <- poll %>%
  mutate(
    date = ymd(date),
    year = year(date),
    month = month(date, label = TRUE)
  ) %>%
  filter(!is.na(date)) %>%      
  filter(!is.na(state))             

poll_clean %>%
  count(year)

poll_clean %>%
  count(state, sort = TRUE)
```

## Year-level trend

```{r}
# National annual average
yearly_pollutants <- poll_clean %>%
  group_by(year) %>%
  summarise(
    o3_mean  = mean(o3_mean,  na.rm = TRUE),
    co_mean  = mean(co_mean,  na.rm = TRUE),
    so2_mean = mean(so2_mean, na.rm = TRUE),
    no2_mean = mean(no2_mean, na.rm = TRUE),
    .groups  = "drop"
  ) %>%
  pivot_longer(
    cols = c(o3_mean, co_mean, so2_mean, no2_mean),
    names_to = "pollutant",
    values_to = "value"
  ) %>%
  mutate(
    pollutant = recode(pollutant,
                       o3_mean  = "O3 (O3 Mean)",
                       co_mean  = "CO (CO Mean)",
                       so2_mean = "SO2 (SO2 Mean)",
                       no2_mean = "NO2 (NO2 Mean)")
  )
```

```{r}
# Line chart(four pollutant)
library(ggplot2)

ggplot(yearly_pollutants,
       aes(x = year, y = value, color = pollutant)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 1.2) +
  scale_x_continuous(breaks = seq(min(yearly_pollutants$year),
                                  max(yearly_pollutants$year), 2)) +
  labs(
    title = "National Average Pollutant Levels by Year (2000–2023)",
    x = "Year",
    y = "Average Concentration",
    color = "Pollutant"
  ) +
  theme_minimal(base_size = 12)
```

```{r}
# Line chart(single pollutant)
p_o3 <- ggplot(filter(yearly_pollutants, pollutant == "O3 (O3 Mean)"),
               aes(x = year, y = value)) +
  geom_line() + geom_point() +
  labs(title = "O3", x = "", y = "")

p_co <- ggplot(filter(yearly_pollutants, pollutant == "CO (CO Mean)"),
               aes(x = year, y = value)) +
  geom_line() + geom_point() +
  labs(title = "CO", x = "", y = "")

p_so2 <- ggplot(filter(yearly_pollutants, pollutant == "SO2 (SO2 Mean)"),
                aes(x = year, y = value)) +
  geom_line() + geom_point() +
  labs(title = "SO2", x = "", y = "")

p_no2 <- ggplot(filter(yearly_pollutants, pollutant == "NO2 (NO2 Mean)"),
                aes(x = year, y = value)) +
  geom_line() + geom_point() +
  labs(title = "NO2", x = "", y = "")

library(patchwork)
(p_o3 | p_co) /
  (p_so2 | p_no2)
```

## State-level trend

```{r}
library(usmap)
# Summarized by state and year(recent 10 years)
state_pollutants <- poll_clean %>%
  filter(year >= 2010) %>%   
  group_by(state) %>%
  summarise(
    o3_mean  = mean(o3_mean,  na.rm = TRUE),
    co_mean  = mean(co_mean,  na.rm = TRUE),
    so2_mean = mean(so2_mean, na.rm = TRUE),
    no2_mean = mean(no2_mean, na.rm = TRUE),
    .groups  = "drop"
  )
```

```{r}
# Choropleth map
plot_usmap(data = state_pollutants,
           regions = "states",
           values = "o3_mean") +
  scale_fill_continuous(
    name = "Avg O3 (2010–2023)",
    label = scales::label_number(accuracy = 0.001)
  ) +
  labs(title = "Average O3 Levels by State (2010–2023)") +
  theme(legend.position = "right")

plot_usmap(data = state_pollutants,
           regions = "states",
           values = "co_mean") +
  scale_fill_continuous(
    name = "Avg O3 (2010–2023)",
    label = scales::label_number(accuracy = 0.001)
  ) +
  labs(title = "Average CO Levels by State (2010–2023)") +
  theme(legend.position = "right")

plot_usmap(data = state_pollutants,
           regions = "states",
           values = "so2_mean") +
  scale_fill_continuous(
    name = "Avg O3 (2010–2023)",
    label = scales::label_number(accuracy = 0.001)
  ) +
  labs(title = "Average SO2 Levels by State (2010–2023)") +
  theme(legend.position = "right")

plot_usmap(data = state_pollutants,
           regions = "states",
           values = "no2_mean") +
  scale_fill_continuous(
    name = "Avg O3 (2010–2023)",
    label = scales::label_number(accuracy = 0.001)
  ) +
  labs(title = "Average NO2 Levels by State (2010–2023)") +
  theme(legend.position = "right")
```

```{r}
# heatmap
state_tile <- state_pollutants %>%
  pivot_longer(cols = c(o3_mean, co_mean, so2_mean, no2_mean),
               names_to = "pollutant",
               values_to = "value") %>%
  mutate(
    pollutant = recode(pollutant,
                       o3_mean  = "O₃",
                       co_mean  = "CO",
                       so2_mean = "SO₂",
                       no2_mean = "NO₂")
  )

ggplot(state_tile,
       aes(x = pollutant, y = fct_reorder(state, value), fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = "State-level Pollution Heatmap (2010–2023 Avg)",
    x = "Pollutant",
    y = "State",
    fill = "Avg Level"
  ) +
  theme_minimal(base_size = 10)
```

## Pollutant Correlation Heatmap

```{r}
library(reshape2)

corr_vars <- poll_clean %>%
  select(o3_mean, co_mean, so2_mean, no2_mean)

corr_mat <- cor(corr_vars, use = "pairwise.complete.obs",
                method = "spearman")

corr_df <- as.data.frame(corr_mat) %>%
  rownames_to_column("var1") %>%
  pivot_longer(-var1, names_to = "var2", values_to = "corr")

ggplot(corr_df, aes(x = var1, y = var2, fill = corr)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(limits = c(-1, 1)) +
  geom_text(aes(label = sprintf("%.2f", corr)), size = 3) +
  labs(
    title = "Spearman Correlation among Pollutants",
    x = "", y = "", fill = "ρ"
  ) +
  theme_minimal(base_size = 12)
```

## Monthly trend

```{r}
# Line chart of monthly pollutants
monthly_season <- poll_clean %>%
  group_by(month) %>%
  summarise(
    o3_mean  = mean(o3_mean,  na.rm = TRUE),
    co_mean  = mean(co_mean,  na.rm = TRUE),
    so2_mean = mean(so2_mean, na.rm = TRUE),
    no2_mean = mean(no2_mean, na.rm = TRUE),
    .groups  = "drop"
  ) %>%
  pivot_longer(cols = c(o3_mean, co_mean, so2_mean, no2_mean),
               names_to = "pollutant", values_to = "value") %>%
  mutate(
    pollutant = recode(pollutant,
                       o3_mean  = "O3",
                       co_mean  = "CO",
                       so2_mean = "SO2",
                       no2_mean = "NO2")
  )

ggplot(monthly_season,
       aes(x = month, y = value, group = pollutant, color = pollutant)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 1.2) +
  labs(
    title = "Seasonal Pattern of Pollutants (Monthly Averages)",
    x = "Month", y = "Average Concentration",
    color = "Pollutant"
  ) +
  theme_minimal(base_size = 12)
```

# Monthly distribution
```{r}
library(ggridges)

ggplot(poll_clean,
       aes(x = o3_mean, y = month, group = month)) +
  geom_density_ridges(scale = 3, rel_min_height = 0.01) +
  labs(
    title = "Monthly Distribution of O3 Levels",
    x = "O3 (O3 Mean)",
    y = "Month"
  ) +
  theme_ridges(font_size = 12)
```

# Facet
```{r}
poll_long_month <- poll_clean %>%
  select(date, year, month, o3_mean, co_mean, so2_mean, no2_mean) %>%
  pivot_longer(cols = c(o3_mean, co_mean, so2_mean, no2_mean),
               names_to = "pollutant", values_to = "value") %>%
  mutate(
    pollutant = recode(pollutant,
                       o3_mean  = "O3",
                       co_mean  = "CO",
                       so2_mean = "SO2",
                       no2_mean = "NO2")
  )

ggplot(poll_long_month,
       aes(x = month, y = value)) +
  geom_boxplot(outlier.alpha = 0.2) +
  facet_wrap(~ pollutant, scales = "free_y", ncol = 2) +
  labs(
    title = "Monthly Distribution of Pollutants",
    x = "Month", y = "Concentration"
  ) +
  theme_minimal(base_size = 12)
```